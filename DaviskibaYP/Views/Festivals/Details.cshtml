@model Domain.ViewModels.Festivals.FestivalDetailsViewModel

@{
    ViewData["Title"] = Model.Title + " — фестиваль";
}

<section class="section-card festival-details">
    <div class="festival-details-header">
        <div class="festival-details-cover">
            @if (!string.IsNullOrWhiteSpace(Model.CoverUrl))
            {
                <img src="@Model.CoverUrl" alt="@Model.Title" />
            }
            else
            {
                <div class="festival-cover-placeholder">GastroFest</div>
            }
        </div>

        <div class="festival-details-main">
            <span class="h-tag">Фестиваль</span>
            <h1>@Model.Title</h1>

            @if (!string.IsNullOrWhiteSpace(Model.City) || !string.IsNullOrWhiteSpace(Model.Country))
            {
                <p class="festival-details-location">
                    @($"{Model.City}{(string.IsNullOrWhiteSpace(Model.Country) ? "" : ", " + Model.Country)}")
                </p>
            }

            <p class="festival-details-dates">
                @Model.StartDate.ToString("dd.MM.yyyy") — @Model.EndDate.ToString("dd.MM.yyyy")
            </p>

            @if (!string.IsNullOrWhiteSpace(Model.Description))
            {
                <p class="festival-details-desc">
                    @Model.Description
                </p>
            }

            @if (User.Identity?.IsAuthenticated ?? false)
            {
                <button id="favBtn"
                        class="btn @(Model.IsFavorite ? "btn-primary" : "btn-outline")"
                        data-festival-id="@Model.Id"
                        data-favorite="@(Model.IsFavorite.ToString().ToLower())">
                    @(Model.IsFavorite ? "В избранном" : "Добавить в избранное")
                </button>
            }
            else
            {
                <p class="festival-details-hint">
                    <span class="muted">Авторизуйтесь, чтобы добавлять фестивали в избранное.</span>
                </p>
            }
        </div>
    </div>

    @* >>> НОРМАЛЬНАЯ ГАЛЕРЕЯ ВНИЗУ КАРТОЧКИ  <<< *@
    @if (Model.Images.Any())
    {
        <div class="festival-details-gallery-wrap">
            <h3 class="festival-details-gallery-title">Фотогалерея</h3>

            <div class="festival-details-gallery">
                @foreach (var img in Model.Images)
                {
                    <div class="festival-gallery-item">
                        <img src="@img.Url" alt="@img.Alt" />
                    </div>
                }
            </div>
        </div>
    }
</section>

@section Scripts {
    <script>
        (function () {
            const btn = document.getElementById('favBtn');
            if (!btn) return;

            btn.addEventListener('click', async function () {
                const id = Number(this.dataset.festivalId);
                try {
                    const res = await fetch('/Festivals/ToggleFavorite', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(id)
                    });

                    if (!res.ok) return;

                    const data = await res.json();
                    if (!data.success) return;

                    const isFav = data.isFavorite === true;
                    this.dataset.favorite = isFav ? 'true' : 'false';
                    this.classList.toggle('btn-primary', isFav);
                    this.classList.toggle('btn-outline', !isFav);
                    this.textContent = isFav ? 'В избранном' : 'Добавить в избранное';
                } catch (e) {
                    console.error(e);
                }
            });
        })();
    </script>
}
